---
import { getCollection } from 'astro:content';

function docsPathFromId(id) {
	const withoutExtension = id.replace(/\.(md|mdx)$/i, '');
	const withoutIndex = withoutExtension.replace(/\/index$/i, '');
	return `/${withoutIndex}/`;
}

function inferDateFromId(id) {
	const match = id.match(/(\d{4})-(\d{2})-(\d{2})/);
	if (!match) return null;
	const [, year, month, day] = match;
	const parsed = new Date(`${year}-${month}-${day}T00:00:00Z`);
	return Number.isNaN(parsed.getTime()) ? null : parsed;
}

const entries = await getCollection('docs', ({ id, data }) => {
	if (!id.startsWith('blog/')) return false;
	if (id.endsWith('/index.md') || id.endsWith('/index.mdx')) return false;
	return data.draft !== true;
});

const posts = entries
	.map((entry) => {
		const publishDate = entry.data.publishDate ?? inferDateFromId(entry.id);
		return {
			id: entry.id,
			title: entry.data.title,
			description: entry.data.summary ?? entry.data.description,
			author: entry.data.author,
			publishDate,
			href: docsPathFromId(entry.id),
		};
	})
	.sort((left, right) => {
		const leftTime = left.publishDate ? left.publishDate.getTime() : 0;
		const rightTime = right.publishDate ? right.publishDate.getTime() : 0;
		return rightTime - leftTime;
	});

const dateFormatter = new Intl.DateTimeFormat('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
---

<section class="helm-blog-listing" aria-label="Blog posts">
	{
		posts.length === 0 ? (
			<p class="helm-blog-empty">No posts published yet.</p>
		) : (
			<ul class="helm-blog-list">
				{
					posts.map((post) => (
						<li class="helm-blog-card">
							<a href={post.href} class="helm-blog-link">
								<div class="helm-blog-meta">
									{post.publishDate && <time datetime={post.publishDate.toISOString()}>{dateFormatter.format(post.publishDate)}</time>}
									{post.author && <span>{post.author}</span>}
								</div>
								<h2>{post.title}</h2>
								<p>{post.description}</p>
							</a>
						</li>
					))
				}
			</ul>
		)
	}
</section>
